---
title: "LPM and logistic regression - Session 9"
format: 
  html:
    self-contained: true
    theme: minty
editor: visual
---

# Recap

## Binary variables

Binary variables are used when there are only two values that a variable can take.

Typical cases are:

-   all questions that can be answered with yes/no - "Do you have siblings?", "Do you own a car?"

-   gender (when including only male/female and no other identities)

Representation in a functional context (in a linear regression):

-   Case 1 (Owns a car= 1): $y_i = \beta_0 + \delta \times 1 + \beta_1 \times x_i$
-   Case 2 (Owns no car = 0): $y_i = \beta_0 + \delta \times 0 + \beta_1 \times x_i$
-   Case 2 reduces to: $y_i = \beta_0 + \beta_1 \times x_i$ (reference model)

Visual Representation:

![](images/Unbenannt.png)

------------------------------------------------------------------------

## Different types of models are used for different purposes:

+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------+
| ### Linear regression                                                                                                                                                      | ### Logistic regression                                                                                                                    |
|                                                                                                                                                                            |                                                                                                                                            |
| A linear regression algorithm d**efines a linear relationship between independent and dependent variables**.                                                               | A logistic regression is not regression, but **classification**, with a binary dependent variable and continuous or categorical variables. |
|                                                                                                                                                                            |                                                                                                                                            |
| It uses a linear equation to identify the line of best fit (straight line) for a problem, thereby **enabling the visualization of the output of the dependent variables.** | It uses independent variables to **predict the occurrence or failure of specific events.**                                                 |
|                                                                                                                                                                            |                                                                                                                                            |
| For example, linear regression may inform us about...                                                                                                                      | For example, logistic regression predicts the chance that...                                                                               |
|                                                                                                                                                                            |                                                                                                                                            |
| -   the influence of education on the income.                                                                                                                              | -   someone passes an exam based on their preparation time.                                                                                |
|                                                                                                                                                                            |                                                                                                                                            |
| -   the influence of gender on grades.                                                                                                                                     | -   someone will get a credit based on their income.                                                                                       |
|                                                                                                                                                                            |                                                                                                                                            |
| -   **the influence of a number of variables on one dependent variable.**                                                                                                  | -   **an outcome will be achieved based on dependent variables.**                                                                          |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------+

## Some Details on Logistic Regression

Key concepts:

1.  Given that the probability of the occurrence of an event ***e*** is ***p**,* or ***(1-p)*** for the probability of its not happening;

2.  Dependent variables are $x_1, x_2, x_3$;

3.  Logistic regression is $y=f(x_1, x_2, x_3)$, where $y$ indicates the probability of ***e*** happening.

4.  Linear regression: $y=\beta_0 + \beta_1 x_1 + \beta_2 x_2 + \beta_3 x_3$

5.  Since we need to bound the outcome variable to be between 0 and 1, we can not fit the model to the data as in linear regression.

6.  Instead, we look at $odds\in[0, +\infty)$: The probability of ***e*** happening rather than not happening;

    $$odds_{e} = \frac{p}{(1-p)}$$

7.  If ***p*** is greater than ***(1-p)***, odds \> 1, and vice versa;

    1.  0 \<= odds \< 1: event ***e*** is not likely to occur;
    2.  1 \<= odds: event ***e*** is likely to occur

8.  Modeling ***y*** is hard, instead, we model ***log(odds)*** with a logit function ***g(.)***

    $$ g(x) = log(odds) = log(\frac{p}{1-p})= \frac{1}{1+e^{-(\beta_0 + \beta_1 x_1 + \beta_2 x_2 + \beta_3 x_3)}}$$

9.  Fit ***g(.)*** with Maximum Likelihood Estimator (MLE) - good to know.

10. Since we transform the y-axis from probability (between 0 and 1) to log-odds, **model coefficients are not interpreted in terms of probability -\>** therefore,we use R's ***margins*** package

## Example in R

### our questions:

1\. **Linear Regression:** How does the age of a house and whether it needs renovations affect its selling price?

2\. **Logistic Regression :** What is the likelihood that a house will be sold in the first 14 days after the listing is up based on its age and whether it needs renovations?

```{r}
#| echo: false
# Set seed for reproducibility
set.seed(101)

# Create a synthetic dataset
n <- 3000  # number of houses

# Generate random house ages (from 0 to 50 years)
house_age <- sample(0:50, n, replace = TRUE)

# Generate random renovation needs (1 = Yes, 0 = No), but influence the outcome heavily
needs_renovation <- rbinom(n, 1, prob = 0.2)  # Assume 20% need renovation


number_of_bedrooms <- sample(1:5, n, replace = TRUE)

lot_size <- round(runif(n, min = 50, max = 500), 0)  # Lot sizes between 50 and 500 square meters
   
garage_presence <- rbinom(n, 1, prob = 0.6)  # Assuming 60% of houses have a garage


# Base price influenced by age and renovation needs, with some noise
house_price <- 300000 - 
  (3000 * house_age) - 
  (30000 * needs_renovation) + 
  (10000 * number_of_bedrooms) +
  (12400 * garage_presence) +
  (1300*lot_size) +
  rnorm(n, mean = 0, sd = 1000)

garage_presence <- as.factor(garage_presence)
needs_renovation <- as.factor(needs_renovation)

house_sold <- ifelse(
  house_age < 15 & needs_renovation == 0 & number_of_bedrooms > 2 & garage_presence == 1 & lot_size > 200, 1,
  ifelse(
    # Adjusting the second condition to allow some sales
    house_age >= 15 & (needs_renovation == 1 | number_of_bedrooms <= 2) & lot_size <= 200, 0,
    rbinom(n, 1, 0.75)  # Increase the probability of 'Yes' to 75%
  )
)

# Convert to factor
house_sold <- as.factor(house_sold)


# Combine into a data frame
data_houses <- data.frame(
  house_age = house_age,
  needs_renovation = as.factor(needs_renovation),
  house_price = house_price,
  house_sold = house_sold,
  number_of_bedrooms = number_of_bedrooms,
  lot_size = lot_size,
  garage_presence = garage_presence
)

head(data_houses)

# Save the dataset to a CSV file
write.csv(data_houses, "house_data.csv", row.names = FALSE)

summary(data_houses)
```

our data: 3000 observations

-   house age: 0 to 50 year old houses
-   house price: 218,150€ to 989,245€
-   house sold: was the house sold in the first 14 days after listing? no=0, yes=1
-   needs renovation: does the house need a bigger renovation? no=0, yes=1
-   number of bedrooms: 1 to 5 bedrooms
-   lot size: the lot is between 50m² and 500m² big
-   garage presence: does the house have a garage? no=0, yes=1

### **Our models**

+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Linear Regression (House Price Explanation):**                                                                                                                                                                                                                                                            | **Logistic Regression (House Sold Prediction):**                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Model:** \`house_price \~ house_age + needs_renovation\`                                                                                                                                                                                                                                                  | **Model:** \`house_sold \~ house_age + needs_renovation\`                                                                                                                                                                                                          |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Intercept (\`β0\`):** The expected price of a house when the age is zero and it does not need renovation (a hypothetical case).                                                                                                                                                                           | **Intercept (\`β0\`):** The log-odds of a house being sold when the house age is zero and it does not need renovations.                                                                                                                                            |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Coefficient for House Age (\`β1\`):** This represents the change in house price for each additional year of age. A negative coefficient indicates that as houses age, their price tends to decrease.                                                                                                      | **Coefficient for House Age (\`β1\`):** Represents the change in log-odds of a house being sold for each additional year of age. A negative coefficient suggests that older houses are less likely to be sold.                                                     |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Coefficient for Needs Renovation (\`β2\`):** This coefficient shows the expected price difference between houses that need renovations and those that do not. A negative coefficient means that houses needing renovation are expected to sell for less than similar houses that do not need renovations. | **Coefficient for Needs Renovation (\`β2\`):** Indicates the change in log-odds of selling a house for those that need renovation. A negative coefficient means that properties requiring renovations have lower odds of being sold compared to those that do not. |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

### Running the regressions:

```{r}
# Linear Regression
linear_model_houses <- lm(house_price ~ house_age + needs_renovation, data = data_houses)
summary(linear_model_houses)

# Logistic Regression
logistic_model_houses <- glm(house_sold ~ house_age + needs_renovation, family = binomial, data = data_houses)
summary(logistic_model_houses)
```

### Interpretation:

Easy for the linear regression, but how do we interpret "log-odds"???

*"In ordinary least squares regression with no interactions or higher-order term, the estimated slope coefficients are marginal effects. In other cases and for generalized linear models, the coefficients are not marginal effects at least not on the scale of the response variable. margins therefore provides ways of calculating the marginal effects of variables to make these models more interpretable."* (Quote from margins package description)

```{r}
#Transforming output of logistic regression to make it interpretable
#install.packages("margins")
#install.packages("stargazer")
library(margins)
library(stargazer)

margins_logistic_model <- margins(logistic_model_houses)
result <- summary(margins_logistic_model)

stargazer(result, type = "text", summary = FALSE)

```

+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Linear Regression - coefficients                                                                                                                                                                           | Logistic Regression - average marginal effects                                                                                                                                                                                                                                                                        |
+============================================================================================================================================================================================================+=======================================================================================================================================================================================================================================================================================================================+
| ```                                                                                                                                                                                                        | ```                                                                                                                                                                                                                                                                                                                   |
| (Intercept)       697965.3***                                                                                                                                                                              | house_age         -0.0043***                                                                                                                                                                                                                                                                                          |
| house_age          -3169.2***                                                                                                                                                                              | needs_renovation1 -0.1335***                                                                                                                                                                                                                                                                                          |
| needs_renovation1 -33006.1***                                                                                                                                                                              | ```                                                                                                                                                                                                                                                                                                                   |
| ```                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                       |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Intercept: for a house that is 0 years old and needs no renovation the price is approx. 697,965.3€. This value is highly significant.                                                                      | Intercept: typically not interpreted when using marginal effects                                                                                                                                                                                                                                                      |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| house age: keeping all other values the same, an additional year in the house age decreases the price by approx. 3.169,2€ - this value is highly significant                                               | house age: the older a house gets the lower its chances for being sold (...) are. This effect is on average -0.43% per year - meaning a decrease in the selling chance of 0.43% with each year that the house gets older. This effect is highly significant.                                                          |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| need for renovation: keeping all other values the same, the house costs approx. 33,006.1€ less if the house needs renovation in comparison to it not needing renovation. This value is highly significant. | need for renovation: when a house needs renovation its chances of being sold are lower in comparison to a house not needing renovation. This effect is on average -13.35%; meaning a decrease in the selling chance of 13.35% in comparison to the house not needing a renovation. This effect is highly significant. |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

Using the model for predictions:

```{r}
coef_linear_model <- coef(linear_model_houses)
intercept_linear_model <- coef_linear_model[1]
b1_hat_linear_model <- coef_linear_model[2]  # coefficient for age 
b2_hat_linear_model <- coef_linear_model[3]  # coefficient for needs renovation

# Estimation of the price for a 10 year old house that needs renovation
age <- 10
renovation <- 1
renovation_needed <- ifelse(renovation == 1, "needs no renovation", "needs renovation")

predicted_price <- intercept_linear_model + b1_hat_linear_model * age + b2_hat_linear_model * renovation
predicted_price <- round(predicted_price, digits = 2)

print(paste("The house that is", age, "years old and", renovation_needed, ", would cost approximatly", predicted_price, "€."))
```

When making a prediction based on certain criteria (house is 10 years old and needs no renovation), we do NOT use marginal effects due to the specific nature of logistic models and effects in them

Instead we use a way to transform the coefficients of the logistic regression into probabilities

```{r}
# Define the house characteristics
   age <- 10
   renovation <- 1  # Needs renovation

# Get coefficients
   intercept_logistic_model <- coef(logistic_model_houses)[1]
   b1_hat_logistic_model <- coef(logistic_model_houses)[2]  # coefficient for house_age
   b2_hat_logistic_model <- coef(logistic_model_houses)[3]  # coefficient for needs_renovation

renovation_needed <- ifelse(renovation == 1, "needs no renovation", "needs renovation")

# calculating log-odds
selling_chance <- intercept_logistic_model + b1_hat_logistic_model * age + b2_hat_logistic_model * renovation

#transforming to percent
selling_chance_percent <- (exp(selling_chance) / (1 + exp(selling_chance)))*100
selling_chance_percent <- round(selling_chance_percent, digits = 2)


print(paste("The house that is", age, "years old and", renovation_needed, ", has a chance to be sold within the first 14 days after listing of approximatly", selling_chance_percent, "%."))
```

## To conclude:

+---------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------+
| Linear regression                                                                                       | Logistic regression                                                                                         |
+=========================================================================================================+=============================================================================================================+
| Used for inference - questions like:                                                                    | Used for predictions:                                                                                       |
|                                                                                                         |                                                                                                             |
| 1.  How does the size of a house affect its selling price given its location, age, and number of rooms? | 1.  Is a customer likely to purchase a product based on their demographics and previous purchase behaviour? |
| 2.  What is the expected income of an individual based on their years of education and work experience? | 2.  Will a patient develop a certain disease based on their lifestyle and medical history?                  |
| 3.  How will the temperature change affect ice cream sales?                                             | 3.  Is a candidate likely to be hired based on their qualifications and interview performance?              |
| 4.  What is the predicted fuel consumption of a car based on its engine size and weight?                | 4.  Will an email be classified as spam or not based on its content and sender information?                 |
+---------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------+
| easy, straight forward interpretation of coefficients, we just have to keep the units in mind           | not so easy to interpret, additional steps needed:                                                          |
|                                                                                                         |                                                                                                             |
|                                                                                                         | -   average marginal effects: used for explaining the model and general directions of effects               |
|                                                                                                         |                                                                                                             |
|                                                                                                         | -   transformed log-odds: used for making predictions based on given values                                 |
+---------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------+
|                                                                                                         |                                                                                                             |
+---------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------+

------------------------------------------------------------------------

# Exercise

### house dataset

We have two models that both use our data set on houses:

```         
lm(formula = house_price ~ lot_size + garage_presence + house_age, data = data_houses)
```

```         
glm(formula = house_sold ~ lot_size + garage_presence + house_age,family = binomial, 
    data = data_houses)
```

1.  What kind of questions do the different regression models answer?

2.  Execute the code for the linear and logistic regression, interpret the coefficients (hint: for logistic regression, use the code examples provided above to transform the values)

3.  Use these values to predict the house price and the chances of the house being sold

    a.  The lot is 250m² big, the house has a garage and is 21 years old
    b.  The lot is 55m² big, the house has no garage and is 49 years old

### airbnbsmall

Given the following code snippet, which models the influence of a set of independent variables (usd_cleaning_fee, d_hottub, d_indoorfireplace, d_heating...) to the rating (independent variable).

1.  Which subset of independent variables should be included in the model and why?
2.  What is the most profound factor that influence the rating according to this model?
3.  How much likely that an airbnb is highly rated if it has an indoor fireplace? what about hottub?

```{r}
library(sozoekds)
library(margins)
library(stargazer)

airbnbsmall <- airbnbsmall

airbnbsmall$highly_rated <- ifelse(airbnbsmall$n_review_scores_rating > 90, 1, 0)
airbnbsmall$highly_rated <- as.factor(airbnbsmall$highly_rated)

model <- glm(highly_rated ~ usd_cleaning_fee + d_hottub + d_indoorfireplace + d_heating, 
             data = airbnbsmall, family = "binomial")

summary(model)

margins_logistic_model <- margins(model)
result <- summary(margins_logistic_model)

stargazer(result, type = "text", summary = FALSE)

```
